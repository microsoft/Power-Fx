#SETUP: RegEx,PowerFxV1CompatibilityRules,SupportColumnNamesAsIdentifiers,DisableMemChecks

// Unicode character behavior in Power Fx regular expressions.
//
//  Effective                                        Usage                 .NET        ECMAScript       PCRE2         Power Fx
// =====================================================================================================================================
//  \p{Ll}\p{Lu}\p{Lt}\p{Lo}\p{Lm}\p{Nd}\p{Pc}       \w, \W, \b, \B        Yes         No               Yes           Yes
//  \p{Nd}                                           \d, \D                Yes         No               Yes           Yes
//  \p{Category}                                     \p, \P                Yes         Yes              Yes           No
//  \p{Script}                                       \p, \P                Yes         Yes              Yes           No (syntax varies)
//
// We chose to use canonical .NET instead of RegexOptions.ECMAScript because we wanted the unicode definitions for words.
// See https://learn.microsoft.com/dotnet/standard/base-types/regular-expression-options#ecmascript-matching-behavior for more details

// Changes in case insensitive matching in .NET 7 causes different answers that are consistent with PCRE2 and Node
// See https://devblogs.microsoft.com/dotnet/regular-expression-improvements-in-dotnet-7/#case-insensitive-matching-and-regexoptions-ignorecase

>> Match( UniChar(Hex2Dec("03a9")), "\u03c9", MatchOptions.IgnoreCase ).FullMatch
"Ω"

>> Match( UniChar(Hex2Dec("03c9")), "\u03a9", MatchOptions.IgnoreCase ).FullMatch
"ω"

#DISABLE.NET:462
>> Match( UniChar(Hex2Dec("03a9")), "\u2126", MatchOptions.IgnoreCase ).FullMatch
"Ω"

#DISABLE.NET:462
>> Match( UniChar(Hex2Dec("03c9")), "\u2126", MatchOptions.IgnoreCase ).FullMatch
"ω"

#DISABLE.NET:462
>> Match( UniChar(Hex2Dec("2126")), "\u03c9", MatchOptions.IgnoreCase ).FullMatch
"Ω"

#DISABLE.NET:462
>> Match( UniChar(Hex2Dec("2126")), "\u03a9", MatchOptions.IgnoreCase ).FullMatch
"Ω"

// newline characters not matched by "."
>> JSON( MatchAll( Char(9) & Char(13) & Char(10) & Char(Hex2Dec("85")) & UniChar(Hex2Dec("2028")) & UniChar(Hex2Dec("2029")) & Char(Hex2Dec("C")) & Char(Hex2Dec("B")) & Char(14), "." ) )
"[{""FullMatch"":""\t"",""StartMatch"":1},{""FullMatch"":""\u000E"",""StartMatch"":9}]"

// surrogate pairs not supported in character class. .NET does not support, JavaScript supports with /u or /v regex modifier, PCRE2 supports

>> UniChar(Hex2Dec("1f600")) = "😀"
true

>> UniChar(Hex2Dec("1F47B")) = "👻"
true

>> Len( "😀" )
2

>> Match( "😀", "[\uD83D\uDE00]" )
Errors: Error 13-29: Invalid regular expression: Unicode characters in surrogate pairs (character U+10000 and above) are not supported in character classes, found "...\uD83D\uDE00".|Error 0-5: The function 'Match' has some invalid arguments.

>> Match( "😀", "[😀]" )
Errors: Error 13-19: Invalid regular expression: Unicode characters in surrogate pairs (character U+10000 and above) are not supported in character classes, found "[😀".|Error 0-5: The function 'Match' has some invalid arguments.

>> Len( Match( "😀", "\uD83D\uDE00" ).FullMatch )
2

>> Len( Match( "😀", "😀" ).FullMatch )
2

>> Match( "😀", "[a-\uD83D\uDE06]" )
Errors: Error 13-31: Invalid regular expression: Unicode characters in surrogate pairs (character U+10000 and above) are not supported in character classes, found "...\uD83D\uDE06".|Error 0-5: The function 'Match' has some invalid arguments.

>> Match( "😀", "[\uD83D\uDE00-\uD83D\uDE06]" )
Errors: Error 13-42: Invalid regular expression: Unicode characters in surrogate pairs (character U+10000 and above) are not supported in character classes, found "...\uD83D\uDE00".|Error 0-5: The function 'Match' has some invalid arguments.

>> Match( "😀", "[😀-👻]" )
Errors: Error 13-22: Invalid regular expression: Unicode characters in surrogate pairs (character U+10000 and above) are not supported in character classes, found "[😀".|Error 0-5: The function 'Match' has some invalid arguments.

>> Match( "😀", "[a\uD83D\uDE00-👻b]" )
Errors: Error 13-34: Invalid regular expression: Unicode characters in surrogate pairs (character U+10000 and above) are not supported in character classes, found "...\uD83D\uDE00".|Error 0-5: The function 'Match' has some invalid arguments.

>> Match( "😀", "[a\uD83D\uDE00-\ud83d\udc7bb]" )
Errors: Error 13-44: Invalid regular expression: Unicode characters in surrogate pairs (character U+10000 and above) are not supported in character classes, found "...\uD83D\uDE00".|Error 0-5: The function 'Match' has some invalid arguments.

>> Match( "😀", "[abc\uD83D\uDE00\ud83d\udc7bdef]" )
Errors: Error 13-47: Invalid regular expression: Unicode characters in surrogate pairs (character U+10000 and above) are not supported in character classes, found "...\uD83D\uDE00".|Error 0-5: The function 'Match' has some invalid arguments.

>> Match( "😀😀😀😀😀", "😀+" )
{FullMatch:"😀😀😀😀😀",StartMatch:1}

>> Match( "ab👻👻cd😀😀ef", "😀+" )  // ghosts each add two characters from StartMatch perspective
{FullMatch:"😀😀",StartMatch:9}

>> Match( "😀😀😀😀😀", "😀{2}" )
{FullMatch:"😀😀",StartMatch:1}

>> Match( "😀😀😀😀😀", "😀?" )
{FullMatch:"😀",StartMatch:1}

>> Match( "👻👻👻👻👻", "😀?" )
{FullMatch:"",StartMatch:1}

>> Match( "👻👻👻👻👻", "😀+" )
Blank()

>> Match( "👻👻👻👻👻", "\uD83D\uDC7B" )
{FullMatch:"👻",StartMatch:1}

>> Match( "👻👻👻👻👻", "\uD83D\uDC7B+" )
{FullMatch:"👻👻👻👻👻",StartMatch:1}

>> Match( "👻👻👻👻👻", "\uD83D\uDC7B?" )
{FullMatch:"👻",StartMatch:1}

>> Match( "👻👻👻👻👻", "\uD83D\uDC7B{3}" )
{FullMatch:"👻👻👻",StartMatch:1}

>> Match( "👻👻👻👻👻", "\uD83D\uDC7B{3,4}" )
{FullMatch:"👻👻👻👻",StartMatch:1}

>> Match( "👻👻👻👻👻", "\uD83D\uDC7B{3,}" )
{FullMatch:"👻👻👻👻👻",StartMatch:1}

>> Match( "👻👻👻👻👻", "\uD83D\uD87B" )
Errors: Error 21-35: Invalid regular expression: Malformed Unicode surrogate pair (character U+10000 and above), found at the end of "\uD83D".|Error 0-5: The function 'Match' has some invalid arguments.

>> Match( "👻👻👻👻👻", "\uDc3D\uDC7B" )
Errors: Error 21-35: Invalid regular expression: Malformed Unicode surrogate pair (character U+10000 and above), found at the end of "\uDc3D".|Error 0-5: The function 'Match' has some invalid arguments.

>> Match( "👻👻👻👻👻", "[\uD83D]" )
Errors: Error 21-31: Invalid regular expression: Malformed Unicode surrogate pair (character U+10000 and above), found at the end of "[\uD83D".|Error 0-5: The function 'Match' has some invalid arguments.

>> Match( "👻👻👻👻👻", "[\uDC7B]" )
Errors: Error 21-31: Invalid regular expression: Malformed Unicode surrogate pair (character U+10000 and above), found at the end of "[\uDC7B".|Error 0-5: The function 'Match' has some invalid arguments.

>> Match( "👻👻👻👻👻", "\uD83D" )
Errors: Error 21-29: Invalid regular expression: Malformed Unicode surrogate pair (character U+10000 and above), found at the end of "\uD83D".|Error 0-5: The function 'Match' has some invalid arguments.

>> Match( "👻👻👻👻👻", "\uDc3D" )
Errors: Error 21-29: Invalid regular expression: Malformed Unicode surrogate pair (character U+10000 and above), found at the end of "\uDc3D".|Error 0-5: The function 'Match' has some invalid arguments.

>> Match( "👻👻👻👻👻", "\uD83Da" )
Errors: Error 21-30: Invalid regular expression: Malformed Unicode surrogate pair (character U+10000 and above), found at the end of "\uD83D".|Error 0-5: The function 'Match' has some invalid arguments.

>> Match( "👻👻👻👻👻", "b\uDc3D" )
Errors: Error 21-30: Invalid regular expression: Malformed Unicode surrogate pair (character U+10000 and above), found at the end of "\uDc3D".|Error 0-5: The function 'Match' has some invalid arguments.

>> Match( "😀", "." )
{FullMatch:"😀",StartMatch:1}

>> Match( "😀", ".*" )
{FullMatch:"😀",StartMatch:1}

>> Match( "😀", ".+" )
{FullMatch:"😀",StartMatch:1}

>> Match( "a😀c%👻%def", "%.%" )
{FullMatch:"%👻%",StartMatch:5}

>> Match( "a😀c%👻%def", "%.%", MatchOptions.DotAll )
{FullMatch:"%👻%",StartMatch:5}

>> Match( "%👻👻a👻👻b👻c👻👻%", "%.{3,}%", MatchOptions.DotAll )
{FullMatch:"%👻👻a👻👻b👻c👻👻%",StartMatch:1}

>> JSON( Match( "%👻👻" & Char(13) & "👻👻" & Char(10) & "👻c👻👻%", "%.{3,}%" ) )
"null"

>> JSON( Match( "%👻👻" & Char(13) & "👻👻" & Char(10) & "👻c👻👻%", "%.{3,}%", MatchOptions.DotAll ) )
"{""FullMatch"":""%\uD83D\uDC7B\uD83D\uDC7B\r\uD83D\uDC7B\uD83D\uDC7B\n\uD83D\uDC7Bc\uD83D\uDC7B\uD83D\uDC7B%"",""StartMatch"":1}"

// case folding ſ (U+017F LATIN SMALL LETTER LONG S) case-folds to s (U+0073 LATIN SMALL LETTER S) 
// case folding K (U+212A KELVIN SIGN) case-folds to k (U+006B LATIN SMALL LETTER K).

>> UniChar( Hex2Dec( "017f" )) = "ſ"
true

>> UniChar( Hex2Dec( "212a" )) = "K"
true

>> Match( "K", "[a-z]" )
Blank()

>> Match( "ſ", "[a-z]" )
Blank()

>> Match( "K", "k", MatchOptions.IgnoreCase )
{FullMatch:"K",StartMatch:1}

// .net does not match this, but node and PCRE2 do: {FullMatch:"ſ",StartMatch:1}
>> Match( "ſ", "s", MatchOptions.IgnoreCase )
Blank()

// .net does not match this, but node and PCRE2 do: {FullMatch:"ſ",StartMatch:1}
>> Match( "ſ", "[a-z]", MatchOptions.IgnoreCase )
Blank()

>> Match( "K", "[a-z]", MatchOptions.IgnoreCase )
{FullMatch:"K",StartMatch:1}

>> Match( "ß", "ss", MatchOptions.IgnoreCase )
Blank()

>> Match( UniChar( Hex2Dec( "2126" ) ), "\u03c9", MatchOptions.IgnoreCase )
{FullMatch:"Ω",StartMatch:1}

>> Match( UniChar( Hex2Dec( "2126" ) ), "\u03a9", MatchOptions.IgnoreCase )
{FullMatch:"Ω",StartMatch:1}

// .net doesn't cover unicode categories above the BMP, node and pcre2 do

>> Match( "👻", "\p{So}" )  // \u{01F47B}
Blank()

>> Match( "𝟭", "\p{Nd}" )   // \u{01D7ED}
Blank()

>> Match( "𐓶", "\p{Ll}" )   // \u{0104F6}
Blank()

// Unicode chars in errors, want to avoid breaking up surrogate pairs in message

>> Match( "a", "\👻" )
Errors: Error 12-17: Invalid regular expression: Invalid escape code, found "\👻".|Error 0-5: The function 'Match' has some invalid arguments.

>> Match( "a", Char(13) & "[\Q]" )
Errors: Error 21-22: Invalid regular expression: Invalid escape code, found " [\Q".|Error 0-5: The function 'Match' has some invalid arguments.

>> Match( "a", "👻👻👻👻👻[\Q]" )
Errors: Error 12-28: Invalid regular expression: Invalid escape code, found "...👻👻👻👻[\Q".|Error 0-5: The function 'Match' has some invalid arguments.

>> Match( "a", "👻👻👻👻👻a[\Q]" )
Errors: Error 12-29: Invalid regular expression: Invalid escape code, found "...👻👻👻👻a[\Q".|Error 0-5: The function 'Match' has some invalid arguments.

>> Match( "a", "👻👻👻👻👻ab[\Q]" )
Errors: Error 12-30: Invalid regular expression: Invalid escape code, found "...👻👻👻ab[\Q".|Error 0-5: The function 'Match' has some invalid arguments.

>> Match( "a", "👻👻👻👻[\Q]" )
Errors: Error 12-26: Invalid regular expression: Invalid escape code, found "👻👻👻👻[\Q".|Error 0-5: The function 'Match' has some invalid arguments.
